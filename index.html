<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=\, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="old_style.css">
    <title>Login page</title>
</head>

<body>
    <div class="row">
        <div class="col-sm-12 col-xl-6 col-md-12 col-lg-6 col-sty">
            <img src="Image/loginImage.png" alt="" class="m-5 p-5 login-img-sty">
            <h3 class="text-center">Optimize Your Workforce Efficiency</h3>
            <p class="text-center">Streamlined time tracking and management for a productive workplace.</p>
        </div>
        <div class="col-sm-12 col-xl-6 col-md-12 col-lg-6">
    
            <div class="container container-sty m-5 p-5 text-center">
                <h2 class="text-center m-3 ">Login</h2>
                <div class="material-textfield mt-4">
                    <input id="username" placeholder=" " type="text" class="input-sty">
                    <label class="label-sty">Username</label>
                </div>
                <div class="material-textfield mt-4">
                    <input id="password" placeholder=" " type="password" class="input-sty">
                    <label class="label-sty">Password</label>
                    <br>
                    <span><a href="" class="span-sty">Forget password</a></span>
                </div>
                <button type="btn" class="btn-sty" id="loginBtn">Submit</button>
                <h5 class="m-3 text-center">Are you<span class="p-2"><a href="singup.html" class="span-colo">Signup In</a></span></h5>
            </div>
        </div>
    </div>

    <script>
  document.getElementById('loginBtn').addEventListener('click', () => {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    loginCheck(username, password)
        .then(isAuthenticated => {
            if (isAuthenticated) {
                alert('Login successful');
                // Redirect to the next page or proceed with the next steps
                window.location.href = "employee_list.html";
            } else {
                alert('Invalid username or password');
            }
        })
        .catch(error => {
            console.error('Error during authentication:', error);
            alert('An error occurred during authentication');
        });
});

// const key1 = localStorage.getItem('key');
const key1 = new Uint8Array([16, 147, 220, 113, 166, 142, 22, 93, 241, 91, 13, 252, 112, 122, 119, 95]);
async function loginCheck(username, password) {
    try {
        const response = await fetch(`https://397vncv6uh.execute-api.us-west-2.amazonaws.com/test/company/getuser/${username}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
else{
        const data = await response.json();
        const decryptPassword = await decrypt(data["Password"],key1)
        const companyID = data["CID"];
        localStorage.setItem('companyID',companyID);
        // localStorage.setItem('companyName', companyName);
      localStorage.setItem('companyLogo', data["CLogo"]);
      localStorage.setItem('companyAddress', data["CAddress"]);
      localStorage.setItem('username', data["UserName"]);
      localStorage.setItem('password', data["Password"]);
        getCustmData(companyID);
        // console.log('Fetched data:', data); // Log the fetched data

        const user = data["UserName"] === username &&  decryptPassword === password;
        // console.log(data["Password"]);
        // console.log(decrypt(data["Password"],key1));
        // console.log(data["UserName"] === username);
        // console.log(decryptPassword === password);

        // console.log('Found user:', data.userName); // Log the found user

        return user ? true : false;
}
    } catch (error) {
        console.error('Login check error:', error);
        return false;
    }
}

//Create decrypt data
async function decrypt(encryptedDataWithIV, key) {
    // Convert Base64 string back to ArrayBuffer
    const buffer = new Uint8Array(atob(encryptedDataWithIV).split('').map(char => char.charCodeAt(0)));
  
    // Split the combined buffer into IV and encrypted data
    const iv = buffer.slice(0, 12);
    const encryptedData = buffer.slice(12);
  
    // Import the decryption key (assuming it's already generated)
    const algorithm = { name: 'AES-GCM', iv: iv };
    const importedKey = await window.crypto.subtle.importKey(
      'raw', key, algorithm, false, ['decrypt']
    );
  
    // Decrypt the data
    const decryptedData = await window.crypto.subtle.decrypt(
      algorithm, importedKey, encryptedData
    );
  
    // Convert decrypted data back to a string
    return new TextDecoder().decode(decryptedData);
  }
  
  function getCustmData(cid1) {
    // let outPut = document.getElementById("demo");
    // const username = document.getElementById('usernameFetch').value;
    const apiUrlBase2 = 'https://397vncv6uh.execute-api.us-west-2.amazonaws.com/test/customer';
    const apiUrl2 = `${apiUrlBase2}/getUsingCID/${cid1}`;
  console.log(cid1);
    // console.log('Username entered:', username);
    console.log('Fetching data from:', apiUrl2);
  
    fetch(apiUrl2)
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`Error: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Data fetched:', data["CustomerID"]);
        localStorage.setItem('customId', data["CustomerID"]);
        localStorage.setItem('firstName', data["FName"]);
        localStorage.setItem('lastName', data["LName"]);
        localStorage.setItem('address', data["Address"]);
        localStorage.setItem('phone', data["PhoneNumber"]);   
        localStorage.setItem('email', data["Email"]);
        // outPut.textContent = JSON.stringify(data, null, 2);
      })
      .catch(error => {
        console.error('Error:', error);
        // outPut.textContent = 'Error fetching data.';
      });
  }
    </script>
</body>

</html>
