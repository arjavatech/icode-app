<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device</title>
    <!-- Bootstrap link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <link rel="stylesheet" href="employee_list.css">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-green">
            <div class="container">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item me-4">
                            <a class="nav-link rounded-pill-active px-4" href="device.html">Device</a>
                        </li>
                        <li class="nav-item me-4">
                            <a class="nav-link" href="employee_list.html">Employee Management</a>
                        </li>
                        <li class="nav-item me-4">
                            <a class="nav-link" href="report_setting.html">Report</a>
                        </li>
                        <li class="nav-item me-4">
                            <a class="nav-link" href="profile.html">Profile</a>
                        </li>
                        <li class="nav-item me-4">
                            <a class="nav-link" href="contact.html">Contact Us</a>
                        </li>
                    </ul>
                    <div>
                        <a href="#" class="btn btn-outline-light" id="logout">Logout</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <div class="container mt-5">
        <div class="add_form_popup">
            <button type="button" onclick="addData()" class="btn btn-green float-end">
                + Add
            </button>
        </div>
        <br><br>
        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
                <thead>
                    <tr>
                        <th>Serial Number</th>
                        <th>Access Key</th>
                        <th>Device Id</th>
                        <th>Device Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById("tableBody");

        const apiUrlBase = "https://397vncv6uh.execute-api.us-west-2.amazonaws.com/test/device";

        function maskString(input, visibleChars) {
            visibleChars = Math.min(visibleChars, input.length);
            const starsCount = input.length - visibleChars;
            const stars = '*'.repeat(starsCount);
            const visiblePart = input.slice(-visibleChars);
            return stars + visiblePart;
        }

        function accessKeyCreate(firstFourDigit, lastFourDigit) {
            const createUuidForAccessKey = uuid.v4().replace(/-/g, '').substring(0, 6);
            return firstFourDigit + createUuidForAccessKey + lastFourDigit;
        }

        function addData() {
            const newRow = document.createElement('tr');
            const serialNumber = tableBody.rows.length + 1;
            newRow.innerHTML = `
            <td>${serialNumber}</td>
            <td class="accesskey"></td>
            <td class="DId"><input type="text" class="form-control" /></td>
            <td class="DName"><input type="text" class="form-control" /></td>
            <td class="Action">
                <button class="btn icon-button btn-outline-green" onClick="delButton(this)">Delete</button>
                <button class="btn icon-button btn-outline-green" onClick="saveDevice(this)">Save</button>
                <button class="btn icon-button btn-outline-green" onClick="copyAccessKey(this)">Copy Key</button>
            </td>
            `;
            tableBody.appendChild(newRow);
            const accesskeyvalFirstDigit = Math.random().toString(36).substring(2, 6);
            const accesskeyvalLastDigit = Math.random().toString(36).substring(2, 6);
            const accessKeyTag = newRow.querySelector(".accesskey");
            const accessKey = accessKeyCreate(accesskeyvalFirstDigit, accesskeyvalLastDigit);
            accessKeyTag.setAttribute("data-key", accessKey);
            accessKeyTag.innerHTML = maskString(accessKey, 4);
        }

        function delButton(button) {
            const row = button.closest('tr');
            const accessKeyTag = row.querySelector(".accesskey");
            const accessKeyValue = accessKeyTag.getAttribute("data-key");
            const companyId = localStorage.getItem('companyID'); // Retrieve the company ID

            fetch(`${apiUrlBase}/delete/${accessKeyValue}/${companyId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status}`);
                    }
                    tableBody.removeChild(row);
                    updateSerialNumbers();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function copyAccessKey(button) {
            const row = button.closest('tr');
            const accessKeyTag = row.querySelector(".accesskey");
            const accessKeyValue = accessKeyTag.getAttribute("data-key");
            navigator.clipboard.writeText(accessKeyValue).then(() => {
                alert("Access key copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function updateSerialNumbers() {
            const rows = tableBody.rows;
            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].innerText = i + 1;
            }
        }

        function viewDevices() {
            const companyId = localStorage.getItem('companyID');
            const apiUrl = `${apiUrlBase}/getAll`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(element => {
                        const newRow = document.createElement('tr');
                        const accessKey = element.AccessKey;
                        newRow.innerHTML = `
                            <td>${tableBody.rows.length + 1}</td>
                            <td class="accesskey" data-key="${accessKey}">${maskString(accessKey, 4)}</td>
                            <td class="DId">${element.DeviceID}</td>
                            <td class="DName">${element.DeviceName}</td>
                            <td class="Action">
                                <button class="btn icon-button btn-outline-green" onClick="delButton(this)">Delete</button>
                                <button class="btn icon-button btn-outline-green" onClick="copyAccessKey(this)">Copy Key</button>
                            </td>
                        `;
                        tableBody.appendChild(newRow);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function saveDevice(button) {
    const row = button.closest('tr');
    const deviceIDInput = row.querySelector(".DId input");
    const deviceNameInput = row.querySelector(".DName input");
    const accessKeyTag = row.querySelector(".accesskey");
    const accessKeyValue = accessKeyTag.getAttribute("data-key");
    const companyId = localStorage.getItem('companyID');

    const newDevice = {
        DeviceID: deviceIDInput.value,
        CID: companyId,
        DeviceName: deviceNameInput.value,
        AccessKey: accessKeyValue,
        AccessKeyGeneratedTime: new Date().toISOString()
    };

    console.log('Saving device:', newDevice); // Log the device being saved

    fetch(`${apiUrlBase}/create`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(newDevice)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Error: ${response.status} - ${text}`);
            });
        }
        // Update the row to display the saved values
        row.querySelector(".DId").innerText = newDevice.DeviceID;
        row.querySelector(".DName").innerText = newDevice.DeviceName;
        button.remove();
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


        document.addEventListener('DOMContentLoaded', viewDevices);
    </script>
</body>

</html>
